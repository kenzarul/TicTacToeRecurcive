{% extends "base.html" %}

{% block body %}
<h1>Ultimate Tic Tac Toe - Multiplayer</h1>

<div id="info">
  <p><strong>Room Code:</strong> {{ game.room_code }}</p>
  <p><strong>Player X:</strong> {{ game.player_x }}</p>
  <p><strong>Player O:</strong> {{ game.player_o }}</p>
  <p><strong>Current Turn:</strong> <span id="current-turn">{{ game.next_player }}</span></p>
</div>

<div id="game-board" style="display: flex; flex-wrap: wrap; width: 630px; margin-top: 20px;">
  {% for big_index in "012345678" %}
    <div class="big-board" style="width: 200px; height: 200px; border: 2px solid black; margin: 5px; display: flex; flex-wrap: wrap;">
      {% for small_index in "012345678" %}
        <div class="small-square"
             data-main="{{ big_index }}"
             data-sub="{{ small_index }}"
             style="width: 60px; height: 60px; border: 1px solid grey; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer;">
        </div>
      {% endfor %}
    </div>
  {% endfor %}
</div>

<div id="winner-message" style="margin-top: 20px; font-size: 24px; color: green;"></div>

<script>

const myPlayer = "{{ game.player_x }}" === "{{ request.user.username }}" ? "{{ game.player_x }}" : "{{ game.player_o }}";
const gameId = "{{ game.id }}";
const currentTurnElement = document.getElementById("current-turn");
const winnerMessage = document.getElementById("winner-message");

let socket = new WebSocket(
    "ws://" + window.location.host + "/ws/game/" + gameId + "/"
);

// ... rest is the same


socket.onopen = function(e) {
    console.log("WebSocket connection established");
};

socket.onmessage = function(e) {
    const data = JSON.parse(e.data);

    if (data.error) {
        alert(data.error);
        return;
    }

    if (data.type === "move") {
        const main = data.main_index;
        const sub = data.sub_index;
        const player = data.player;
        const nextPlayer = data.next_player;
        const winner = data.winner;

        const squares = document.querySelectorAll(`.small-square[data-main="${main}"][data-sub="${sub}"]`);
        if (squares.length > 0) {
            squares[0].textContent = player;
            squares[0].style.pointerEvents = 'none';  // prevent playing again
        }

        if (winner) {
            winnerMessage.textContent = winner === ' ' ? "Stalemate!" : `${winner} wins the game! ðŸŽ‰`;
            socket.close();
        } else {
            currentTurnElement.textContent = nextPlayer;
        }
    }
};

socket.onclose = function(e) {
    console.log("WebSocket closed");
};

socket.onerror = function(e) {
    console.error("WebSocket error:", e);
};

// Allow clicking squares
document.querySelectorAll(".small-square").forEach(square => {
    square.addEventListener("click", function() {
        const main = this.getAttribute("data-main");
        const sub = this.getAttribute("data-sub");

        socket.send(JSON.stringify({
            "main_index": parseInt(main),
            "sub_index": parseInt(sub),
            "player": myPlayer
        }));
    });
});
</script>

{% endblock %}
