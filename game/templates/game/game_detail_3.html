{% extends "base.html" %}

{% block body %}
<!-- Game Result Modal -->
<div id="gameResultModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="resultTitle"></h2>
    </div>
    <div class="modal-body">
      <p id="resultMessage"></p>
        <div class="confetti-container"></div>
    </div>
      <audio id="confettiSound" preload="auto">
    <source src="https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3" type="audio/mpeg">
    </audio>
    <div class="modal-footer">
      <a href="{% url 'game:index' %}" class="modal-btn new-game">New Game</a>
      <a href="{% url 'game:main_menu' %}" class="modal-btn exit">Exit</a>
    </div>
  </div>
</div>

{% with next_player=game.next_player game_over=game.is_game_over %}
  {% if game_over == 'X' or game_over == 'O' or game_over == ' ' %}
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        showResultModal("{{ game_over }}");
      });
    </script>
  {% else %}
    <h2>{{ next_player }} to play</h2>
    {% if game.active_index != None %}
      <h3>Playing in board {{ active_index }}</h3>
    {% endif %}
  {% endif %}

        <div class="ultimate-board" style="display: flex; border: 2px solid black">
            <!-- Top row of big boards -->
            <div class="big-row">
                <!-- Board 0 -->
                <div class="board {% if game.active_index is None and game.board.0 == ' ' %}playable-board {% elif active_index == 0 %}active{% endif %} {% if sub_game_0.winner %}{% if sub_game_0.winner == 'X' and game.player_x == 'human' or sub_game_0.winner == 'O' and game.player_o == 'human' %}won-human{% else %}won-ai{% endif %}{% endif %}">
                    <div class="row">
                        <div class="board-square {% if i == last_move_index %}rainbow-color{% endif %} {%if active_index == 0 or active_index is None and game.board.0 == ' ' %}playable-board{% endif%}">
                        {% include "includes/square.html" with game=game board=0 index=0 play=sub_game_0.board.0 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=0 %}
                        {% include "includes/square.html" with game=game board=0 index=1 play=sub_game_0.board.1 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=0 %}
                        {% include "includes/square.html" with game=game board=0 index=2 play=sub_game_0.board.2 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=0 %}
                        </div>
                    </div>
                    <div class="row">
                         <div class="board-square {% if i == last_move_index %}rainbow-color{% endif %} {%if active_index == 0 or active_index is None and game.board.0 == ' ' %}playable-board{% endif%}">
                        {% include "includes/square.html" with game=game board=0 index=3 play=sub_game_0.board.3 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=0 %}
                        {% include "includes/square.html" with game=game board=0 index=4 play=sub_game_0.board.4 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=0 %}
                        {% include "includes/square.html" with game=game board=0 index=5 play=sub_game_0.board.5 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=0 %}
                        </div>
                    </div>
                    <div class="row">
                         <div class="board-square {% if i == last_move_index %}rainbow-color{% endif %} {%if active_index == 0 or active_index is None and game.board.0 == ' ' %}playable-board{% endif%}">
                        {% include "includes/square.html" with game=game board=0 index=6 play=sub_game_0.board.6 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=0 %}
                        {% include "includes/square.html" with game=game board=0 index=7 play=sub_game_0.board.7 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=0 %}
                        {% include "includes/square.html" with game=game board=0 index=8 play=sub_game_0.board.8 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=0 %}
                        </div>
                    </div>
                </div>

                <div class="board {% if game.active_index is None and game.board.1 == ' ' %}playable-board {% elif active_index == 1 %}active{% endif %} {% if sub_game_1.winner %}{% if sub_game_1.winner == 'X' and game.player_x == 'human' or sub_game_1.winner == 'O' and game.player_o == 'human' %}won-human{% else %}won-ai{% endif %}{% endif %}">
                    <div class="row">
                        <div class="board-square {% if i == last_move_index %}rainbow-color{% endif %} {%if active_index == 1 or active_index is None and game.board.1 == ' ' %}playable-board{% endif%}">
                        {% include "includes/square.html" with game=game board=1 index=0 play=sub_game_1.board.0 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=1 %}
                        {% include "includes/square.html" with game=game board=1 index=1 play=sub_game_1.board.1 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=1 %}
                        {% include "includes/square.html" with game=game board=1 index=2 play=sub_game_1.board.2 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=1 %}
                        </div>
                    </div>
                    <div class="row">
                        <div class="board-square {% if i == last_move_index %}rainbow-color{% endif %} {%if active_index == 1 or active_index is None and game.board.1 == ' ' %}playable-board{% endif%}">
                        {% include "includes/square.html" with game=game board=1 index=3 play=sub_game_1.board.3 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=1 %}
                        {% include "includes/square.html" with game=game board=1 index=4 play=sub_game_1.board.4 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=1 %}
                        {% include "includes/square.html" with game=game board=1 index=5 play=sub_game_1.board.5 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=1 %}
                        </div>
                    </div>
                    <div class="row">
                        <div class="board-square {% if i == last_move_index %}rainbow-color{% endif %} {%if active_index == 1 or active_index is None and game.board.1 == ' ' %}playable-board{% endif%}">
                        {% include "includes/square.html" with game=game board=1 index=6 play=sub_game_1.board.6 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=1 %}
                        {% include "includes/square.html" with game=game board=1 index=7 play=sub_game_1.board.7 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=1 %}
                        {% include "includes/square.html" with game=game board=1 index=8 play=sub_game_1.board.8 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=1 %}
                        </div>
                    </div>
                </div>


                <!-- Board 2 -->
                <div class="board {% if game.active_index is None and game.board.2 == ' ' %}playable-board {% elif active_index == 2 %}active{% endif %} {% if sub_game_2.winner %}{% if sub_game_2.winner == 'X' and game.player_x == 'human' or sub_game_2.winner == 'O' and game.player_o == 'human' %}won-human{% else %}won-ai{% endif %}{% endif %}">
                    <div class="row">
                        <div class="board-square {% if i == last_move_index %}rainbow-color{% endif %} {%if active_index == 2 or active_index is None and game.board.2 == ' ' %}playable-board{% endif%}">
                        {% include "includes/square.html" with game=game board=2 index=0 play=sub_game_2.board.0 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=2 %}
                        {% include "includes/square.html" with game=game board=2 index=1 play=sub_game_2.board.1 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=2 %}
                        {% include "includes/square.html" with game=game board=2 index=2 play=sub_game_2.board.2 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=2 %}
                        </div>
                    </div>
                    <div class="row">
                        <div class="board-square {% if i == last_move_index %}rainbow-color{% endif %} {%if active_index == 2 or active_index is None and game.board.2 == ' ' %}playable-board{% endif%}">
                        {% include "includes/square.html" with game=game board=2 index=3 play=sub_game_2.board.3 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=2 %}
                        {% include "includes/square.html" with game=game board=2 index=4 play=sub_game_2.board.4 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=2 %}
                        {% include "includes/square.html" with game=game board=2 index=5 play=sub_game_2.board.5 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=2 %}
                        </div>
                    </div>
                    <div class="row">
                        <div class="board-square {% if i == last_move_index %}rainbow-color{% endif %} {%if active_index == 2 or active_index is None and game.board.2 == ' ' %}playable-board{% endif%}">
                        {% include "includes/square.html" with game=game board=2 index=6 play=sub_game_2.board.6 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=2 %}
                        {% include "includes/square.html" with game=game board=2 index=7 play=sub_game_2.board.7 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=2 %}
                        {% include "includes/square.html" with game=game board=2 index=8 play=sub_game_2.board.8 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=2 %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Middle row of big boards -->
            <div class="big-row">
                <!-- Board 3 -->
                <div class="board {% if game.active_index is None and game.board.3 == ' ' %}playable-board {% elif active_index == 3 %}active{% endif %} {% if sub_game_3.winner %}{% if sub_game_3.winner == 'X' and game.player_x == 'human' or sub_game_3.winner == 'O' and game.player_o == 'human' %}won-human{% else %}won-ai{% endif %}{% endif %}">
                    <div class="row">
                        <div class="board-square {% if i == last_move_index %}rainbow-color{% endif %} {%if active_index == 3 or active_index is None and game.board.3 == ' ' %}playable-board{% endif%}">
                        {% include "includes/square.html" with game=game board=3 index=0 play=sub_game_3.board.0 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=3 %}
                        {% include "includes/square.html" with game=game board=3 index=1 play=sub_game_3.board.1 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=3 %}
                        {% include "includes/square.html" with game=game board=3 index=2 play=sub_game_3.board.2 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=3 %}
                        </div>
                    </div>
                    <div class="row">
                        <div class="board-square {% if i == last_move_index %}rainbow-color{% endif %} {%if active_index == 3 or active_index is None and game.board.3 == ' ' %}playable-board{% endif%}">
                        {% include "includes/square.html" with game=game board=3 index=3 play=sub_game_3.board.3 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=3 %}
                        {% include "includes/square.html" with game=game board=3 index=4 play=sub_game_3.board.4 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=3 %}
                        {% include "includes/square.html" with game=game board=3 index=5 play=sub_game_3.board.5 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=3 %}
                        </div>
                    </div>
                    <div class="row">
                        <div class="board-square {% if i == last_move_index %}rainbow-color{% endif %} {%if active_index == 3 or active_index is None and game.board.3 == ' ' %}playable-board{% endif%}">
                        {% include "includes/square.html" with game=game board=3 index=6 play=sub_game_3.board.6 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=3 %}
                        {% include "includes/square.html" with game=game board=3 index=7 play=sub_game_3.board.7 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=3 %}
                        {% include "includes/square.html" with game=game board=3 index=8 play=sub_game_3.board.8 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=3 %}
                        </div>
                    </div>
                </div>


                <!-- Board 4 -->
                <div class="board {% if game.active_index is None and game.board.4 == ' ' %}playable-board {% elif active_index == 4 %}active{% endif %} {% if sub_game_4.winner %}{% if sub_game_4.winner == 'X' and game.player_x == 'human' or sub_game_4.winner == 'O' and game.player_o == 'human' %}won-human{% else %}won-ai{% endif %}{% endif %}">
                    <div class="row">
                        <div class="board-square {% if i == last_move_index %}rainbow-color{% endif %} {%if active_index == 4 or active_index is None and game.board.4 == ' ' %}playable-board{% endif%}">
                        {% include "includes/square.html" with game=game board=4 index=0 play=sub_game_4.board.0 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=4 %}
                        {% include "includes/square.html" with game=game board=4 index=1 play=sub_game_4.board.1 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=4 %}
                        {% include "includes/square.html" with game=game board=4 index=2 play=sub_game_4.board.2 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=4 %}
                        </div>
                    </div>
                    <div class="row">
                        <div class="board-square {% if i == last_move_index %}rainbow-color{% endif %} {%if active_index == 4 or active_index is None and game.board.4 == ' ' %}playable-board{% endif%}">
                        {% include "includes/square.html" with game=game board=4 index=3 play=sub_game_4.board.3 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=4 %}
                        {% include "includes/square.html" with game=game board=4 index=4 play=sub_game_4.board.4 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=4 %}
                        {% include "includes/square.html" with game=game board=4 index=5 play=sub_game_4.board.5 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=4 %}
                        </div>
                    </div>
                    <div class="row">
                        <div class="board-square {% if i == last_move_index %}rainbow-color{% endif %} {%if active_index == 4 or active_index is None and game.board.4 == ' ' %}playable-board{% endif%}">
                        {% include "includes/square.html" with game=game board=4 index=6 play=sub_game_4.board.6 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=4 %}
                        {% include "includes/square.html" with game=game board=4 index=7 play=sub_game_4.board.7 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=4 %}
                        {% include "includes/square.html" with game=game board=4 index=8 play=sub_game_4.board.8 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=4 %}
                        </div>
                    </div>
                </div>

                <!-- Board 5 -->
                <div class="board {% if game.active_index is None and game.board.5 == ' ' %}playable-board {% elif active_index == 5 %}active{% endif %} {% if sub_game_5.winner %}{% if sub_game_5.winner == 'X' and game.player_x == 'human' or sub_game_5.winner == 'O' and game.player_o == 'human' %}won-human{% else %}won-ai{% endif %}{% endif %}">
                    <div class="row">
                        <div class="board-square {% if i == last_move_index %}rainbow-color{% endif %} {%if active_index == 5 or active_index is None and game.board.5 == ' ' %}playable-board{% endif%}">
                        {% include "includes/square.html" with game=game board=5 index=0 play=sub_game_5.board.0 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=5 %}
                        {% include "includes/square.html" with game=game board=5 index=1 play=sub_game_5.board.1 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=5 %}
                        {% include "includes/square.html" with game=game board=5 index=2 play=sub_game_5.board.2 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=5 %}
                        </div>
                    </div>
                    <div class="row">
                        <div class="board-square {% if i == last_move_index %}rainbow-color{% endif %} {%if active_index == 5 or active_index is None and game.board.5 == ' ' %}playable-board{% endif%}">
                        {% include "includes/square.html" with game=game board=5 index=3 play=sub_game_5.board.3 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=5 %}
                        {% include "includes/square.html" with game=game board=5 index=4 play=sub_game_5.board.4 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=5 %}
                        {% include "includes/square.html" with game=game board=5 index=5 play=sub_game_5.board.5 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=5 %}
                        </div>
                    </div>
                    <div class="row">
                        <div class="board-square {% if i == last_move_index %}rainbow-color{% endif %} {%if active_index == 5 or active_index is None and game.board.5 == ' ' %}playable-board{% endif%}">
                        {% include "includes/square.html" with game=game board=5 index=6 play=sub_game_5.board.6 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=5 %}
                        {% include "includes/square.html" with game=game board=5 index=7 play=sub_game_5.board.7 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=5 %}
                        {% include "includes/square.html" with game=game board=5 index=8 play=sub_game_5.board.8 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=5 %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bottom row of big boards -->
            <div class="big-row">
                <!-- Board 6 -->
                <div class="board {% if game.active_index is None and game.board.6 == ' ' %}playable-board {% elif active_index == 6 %}active{% endif %} {% if sub_game_6.winner %}{% if sub_game_6.winner == 'X' and game.player_x == 'human' or sub_game_6.winner == 'O' and game.player_o == 'human' %}won-human{% else %}won-ai{% endif %}{% endif %}">
                    <div class="row">
                        <div class="board-square {% if i == last_move_index %}rainbow-color{% endif %} {%if active_index == 6 or active_index is None and game.board.6 == ' ' %}playable-board{% endif%}">
                        {% include "includes/square.html" with game=game board=6 index=0 play=sub_game_6.board.0 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=6 %}
                        {% include "includes/square.html" with game=game board=6 index=1 play=sub_game_6.board.1 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=6 %}
                        {% include "includes/square.html" with game=game board=6 index=2 play=sub_game_6.board.2 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=6 %}
                        </div>
                    </div>
                    <div class="row">
                        <div class="board-square {% if i == last_move_index %}rainbow-color{% endif %} {%if active_index == 6 or active_index is None and game.board.6 == ' ' %}playable-board{% endif%}">
                        {% include "includes/square.html" with game=game board=6 index=3 play=sub_game_6.board.3 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=6 %}
                        {% include "includes/square.html" with game=game board=6 index=4 play=sub_game_6.board.4 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=6 %}
                        {% include "includes/square.html" with game=game board=6 index=5 play=sub_game_6.board.5 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=6 %}
                        </div>
                    </div>
                    <div class="row">
                        <div class="board-square {% if i == last_move_index %}rainbow-color{% endif %} {%if active_index == 6 or active_index is None and game.board.6 == ' ' %}playable-board{% endif%}">
                        {% include "includes/square.html" with game=game board=6 index=6 play=sub_game_6.board.6 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=6 %}
                        {% include "includes/square.html" with game=game board=6 index=7 play=sub_game_6.board.7 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=6 %}
                        {% include "includes/square.html" with game=game board=6 index=8 play=sub_game_6.board.8 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=6 %}
                        </div>
                    </div>
                </div>

                <!-- Board 7 -->
                <div class="board {% if game.active_index is None and game.board.7 == ' ' %}playable-board {% elif active_index == 7 %}active{% endif %} {% if sub_game_7.winner %}{% if sub_game_7.winner == 'X' and game.player_x == 'human' or sub_game_7.winner == 'O' and game.player_o == 'human' %}won-human{% else %}won-ai{% endif %}{% endif %}">
                    <div class="row">
                        <div class="board-square {% if i == last_move_index %}rainbow-color{% endif %} {%if active_index == 7 or active_index is None and game.board.7 == ' ' %}playable-board{% endif%}">
                        {% include "includes/square.html" with game=game board=7 index=0 play=sub_game_7.board.0 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=7 %}
                        {% include "includes/square.html" with game=game board=7 index=1 play=sub_game_7.board.1 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=7 %}
                        {% include "includes/square.html" with game=game board=7 index=2 play=sub_game_7.board.2 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=7 %}
                        </div>
                    </div>
                    <div class="row">
                        <div class="board-square {% if i == last_move_index %}rainbow-color{% endif %} {%if active_index == 7 or active_index is None and game.board.7 == ' ' %}playable-board{% endif%}">
                        {% include "includes/square.html" with game=game board=7 index=3 play=sub_game_7.board.3 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=7 %}
                        {% include "includes/square.html" with game=game board=7 index=4 play=sub_game_7.board.4 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=7 %}
                        {% include "includes/square.html" with game=game board=7 index=5 play=sub_game_7.board.5 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=7 %}
                        </div>
                    </div>
                    <div class="row">
                        <div class="board-square {% if i == last_move_index %}rainbow-color{% endif %} {%if active_index == 7 or active_index is None and game.board.7 == ' ' %}playable-board{% endif%}">
                        {% include "includes/square.html" with game=game board=7 index=6 play=sub_game_7.board.6 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=7 %}
                        {% include "includes/square.html" with game=game board=7 index=7 play=sub_game_7.board.7 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=7 %}
                        {% include "includes/square.html" with game=game board=7 index=8 play=sub_game_7.board.8 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=7 %}
                        </div>
                    </div>
                </div>

                <!-- Board 8 -->
                <div class="board {% if game.active_index is None and game.board.8 == ' ' %}playable-board {% elif active_index == 8 %}active{% endif %} {% if sub_game_8.winner %}{% if sub_game_8.winner == 'X' and game.player_x == 'human' or sub_game_8.winner == 'O' and game.player_o == 'human' %}won-human{% else %}won-ai{% endif %}{% endif %}">
                    <div class="row">
                        <div class="board-square {% if i == last_move_index %}rainbow-color{% endif %} {%if active_index == 8 or active_index is None and game.board.8 == ' ' %}playable-board{% endif%}">
                        {% include "includes/square.html" with game=game board=8 index=0 play=sub_game_8.board.0 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=8 %}
                        {% include "includes/square.html" with game=game board=8 index=1 play=sub_game_8.board.1 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=8 %}
                        {% include "includes/square.html" with game=game board=8 index=2 play=sub_game_8.board.2 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=8 %}
                        </div>
                    </div>
                    <div class="row">
                        <div class="board-square {% if i == last_move_index %}rainbow-color{% endif %} {%if active_index == 8 or active_index is None and game.board.8 == ' ' %}playable-board{% endif%}">
                        {% include "includes/square.html" with game=game board=8 index=3 play=sub_game_8.board.3 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=8 %}
                        {% include "includes/square.html" with game=game board=8 index=4 play=sub_game_8.board.4 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=8 %}
                        {% include "includes/square.html" with game=game board=8 index=5 play=sub_game_8.board.5 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=8 %}
                        </div>
                    </div>
                    <div class="row">
                        <div class="board-square {% if i == last_move_index %}rainbow-color{% endif %} {%if active_index == 8 or active_index is None and game.board.8 == ' ' %}playable-board{% endif%}">
                        {% include "includes/square.html" with game=game board=8 index=6 play=sub_game_8.board.6 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=8 %}
                        {% include "includes/square.html" with game=game board=8 index=7 play=sub_game_8.board.7 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=8 %}
                        {% include "includes/square.html" with game=game board=8 index=8 play=sub_game_8.board.8 last_main_index=last_main_index last_sub_index=last_sub_index current_main_index=8 %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
{% endwith %}



<script>
function showResultModal(result) {
    const modal = document.getElementById('gameResultModal');
    const title = document.getElementById('resultTitle');
    const message = document.getElementById('resultMessage');
    const confettiContainer = document.querySelector('.confetti-container');
    const confettiSound = document.getElementById('confettiSound');

    // Clear previous confetti
    confettiContainer.innerHTML = '';

    // Determine if the player lost (algorithm won)
    const playerLost = (result === 'X' && "{{ game.player_x }}" !== "human") ||
                  (result === 'O' && "{{ game.player_o }}" !== "human");

    if (result === 'X') {
        if (playerLost) {
            title.textContent = 'ðŸ’€ You Lose! ðŸ’€';
            message.textContent = 'Player X (Algorithm) Wins!';
        } else {
            title.textContent = 'ðŸŽ‰ Bravo! ðŸŽ‰';
            message.textContent = 'Player X Wins the Game!';
        }
    } else if (result === 'O') {
        if (playerLost) {
            title.textContent = 'ðŸ’€ You Lose! ðŸ’€';
            message.textContent = 'Player O (Algorithm) Wins!';
        } else {
            title.textContent = 'ðŸŽ‰ Bravo! ðŸŽ‰';
            message.textContent = 'Player O Wins the Game!';
        }
    } else {
        title.textContent = 'ðŸŽ‰ Game Over! ðŸŽ‰';
        message.textContent = 'The game ended in a stalemate!';
    }

    modal.style.display = 'block';
    modal.classList.add('fade-in');
    document.querySelector('.modal-content').classList.add('slide-down');

    // Create particles based on win/lose
    if (playerLost) {
        // Create rain effect for losing
        for (let i = 0; i < 100; i++) {
            const drop = document.createElement('div');
            drop.classList.add('rain-drop');

            // Random positioning
            drop.style.left = Math.random() * 100 + 'vw';
            drop.style.top = -10 + 'px';

            // Random animation duration
            drop.style.animationDuration = 1 + Math.random() * 2 + 's';

            // Random delay
            drop.style.animationDelay = Math.random() * 2 + 's';

            // Random size
            const size = 1 + Math.random() * 3;
            drop.style.width = size + 'px';
            drop.style.height = size * 5 + 'px';

            confettiContainer.appendChild(drop);
        }
    } else {
        // Create confetti for winning
        for (let i = 0; i < 150; i++) {
            const confetti = document.createElement('div');
            confetti.classList.add('confetti');

            // Random positioning
            confetti.style.left = Math.random() * 100 + 'vw';
            confetti.style.top = -10 + 'px';

            // Random animation duration
            confetti.style.animationDuration = 3 + Math.random() * 4 + 's';

            // Random delay
            confetti.style.animationDelay = Math.random() * 2 + 's';

            // Random size
            const size = 5 + Math.random() * 10;
            confetti.style.width = size + 'px';
            confetti.style.height = size + 'px';

            confettiContainer.appendChild(confetti);
        }
    }

    // Play celebration sound
    confettiSound.volume = 0.3;
    confettiSound.currentTime = 0;
    confettiSound.play().catch(e => console.log("Audio play failed:", e));
}
</script>
{% endblock %}