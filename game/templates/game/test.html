{% extends "base.html" %}
{% block body %}

<!-- Waiting Room -->
<div id="waiting-room" style="text-align:center; margin-top:30px;">
  <h2>Ultimate Tic Tac Toe ‚Äì Multiplayer</h2>
  <p><strong>Room Code:</strong> <span id="room-code">{{ game.room_code }}</span>
     <button onclick="copyCode()">üìã Copy</button></p>
  <p><strong>Username:</strong> {{ request.user.username }}</p>
  <h3>‚è≥ Waiting for another player to join...</h3>
</div>

<!-- Game Info Panel -->
<div id="info-panel" style="display:none; text-align:center; margin-bottom:20px;">
  <h2>Ultimate Tic Tac Toe ‚Äì Multiplayer</h2>
  <p><strong>You:</strong> <span id="assigned-player">?</span> &nbsp; | &nbsp;
     <strong>Opponent:</strong> <span id="opponent-name">?</span></p>
  <p><strong>Turn:</strong> <span id="current-turn">-</span></p>
  <div style="position:absolute; top:20px; right:20px; font-size:18px;">
    <div>‚è± X: <span id="timer-x">0:00</span></div>
    <div>‚è± O: <span id="timer-o">0:00</span></div>
  </div>
  <button id="surrender-btn" style="padding:8px 16px; font-size:16px; margin-top:10px;">üö© Surrender</button>
  <div id="vote-panel" style="display:none; margin-top:10px;">
    <span>Replay? </span>
    <button id="vote-yes">üëç Yes</button>
    <button id="vote-no">üëé No</button>
    <p id="vote-status"></p>
  </div>
</div>

<!-- Game Board -->
<div id="game-board" style="display:none; width:650px; margin:auto; display:grid; grid-template-columns:repeat(3,1fr); gap:5px;">
  {% for big in "012345678" %}
    <div class="big-board" data-board-index="{{ big }}"
         style="display:grid; grid-template-columns:repeat(3,1fr); width:200px; height:200px; border:2px solid #333; transition: box-shadow 0.3s ease;">
      {% for small in "012345678" %}
        <div class="small-square"
             data-main="{{ big }}" data-sub="{{ small }}"
             style="border:1px solid #999; display:flex;
                    align-items:center; justify-content:center; font-size:24px; cursor:pointer;">
        </div>
      {% endfor %}
    </div>
  {% endfor %}
</div>

<!-- Modal Result -->
<div id="gameResultModal" class="modal" style="display:none;">
  <div class="modal-content">
    <div class="modal-header"><h2 id="resultTitle"></h2></div>
    <div class="modal-body">
      <p id="resultMessage"></p>
      <div class="confetti-container"></div>
    </div>
    <audio id="confettiSound" preload="auto">
      <source src="https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3" type="audio/mpeg">
    </audio>
    <div class="modal-footer">
      <button id="replay-btn" class="modal-btn new-game" style="display:none">Play Again</button>
      <button id="exit-btn" class="modal-btn exit">Exit</button>
    </div>
  </div>
</div>

<script>
function copyCode() {
  navigator.clipboard.writeText(document.getElementById("room-code").textContent);
  alert("Room code copied!");
}

let myPlayer = null;
let votes = { X: false, O: false };
let timer = { X: 300, O: 300 };
let interval = null;
let currentActive = null;
let subgameWinners = Array(9).fill(null);

function formatTime(seconds) {
  const m = Math.floor(seconds / 60);
  const s = seconds % 60;
  return `${m}:${String(s).padStart(2, '0')}`;
}

function updateTimers() {
  const turn = document.getElementById("current-turn").textContent;
  if (turn === 'X' || turn === 'O') {
    timer[turn]--;
    document.getElementById(`timer-${turn.toLowerCase()}`).textContent = formatTime(timer[turn]);
    if (timer[turn] <= 0) {
      clearInterval(interval);
      showResult(turn === 'X' ? 'O' : 'X', `${turn} ran out of time!`);
    }
  }
}

function updateSquareColors(turn) {
  document.querySelectorAll(".small-square").forEach(sq => {
    if (!sq.textContent) {
      sq.style.backgroundColor = '';
    }
  });
  if (currentActive !== null) {
    const targetBig = document.querySelector(`.big-board[data-board-index='${currentActive}']`);
    if (targetBig && subgameWinners[currentActive] === null) {
      targetBig.querySelectorAll('.small-square').forEach(sq => {
        if (!sq.textContent)
          sq.style.backgroundColor = turn === 'X' ? '#ffcaca' : '#ccffcc';
      });
    } else {
      document.querySelectorAll('.big-board').forEach((big, idx) => {
        if (subgameWinners[idx] === null) {
          big.querySelectorAll('.small-square').forEach(sq => {
            if (!sq.textContent)
              sq.style.backgroundColor = turn === 'X' ? '#ffcaca' : '#ccffcc';
          });
        }
      });
    }
  }
}

const socket = new WebSocket("ws://" + window.location.host + "/ws/game/{{ game.room_code }}/");

socket.onmessage = e => {
  const data = JSON.parse(e.data);
  switch (data.type) {
    case 'player_assignment':
      myPlayer = data.player;
      document.getElementById("assigned-player").textContent = myPlayer;
      break;

    case 'start':
      document.getElementById("waiting-room").style.display = 'none';
      document.getElementById("info-panel").style.display = 'block';
      document.getElementById("game-board").style.display = 'grid';
      document.getElementById("opponent-name").textContent = (data.player_x === myPlayer ? data.player_o : data.player_x) || "Waiting...";
      timer.X = data.time_x;
      timer.O = data.time_o;
      document.getElementById("timer-x").textContent = formatTime(timer.X);
      document.getElementById("timer-o").textContent = formatTime(timer.O);
      if (interval) clearInterval(interval);
      interval = setInterval(updateTimers, 1000);
      document.getElementById("current-turn").textContent = data.next_player;
      resetGameUI();
      updateSquareColors(data.next_player);
      break;

    case 'move':
      const sq = document.querySelector(`[data-main="${data.main_index}"][data-sub="${data.sub_index}"]`);
      if (sq) {
        sq.textContent = data.player;
        sq.style.pointerEvents = 'none';
        sq.style.color = data.player === 'X' ? 'red' : 'green';
      }
      if (data.winner) {
        subgameWinners[data.main_index] = data.player;
      }
      currentActive = data.active_index;
      document.getElementById("current-turn").textContent = data.next_player;
      highlightActive(data.active_index);
      updateSquareColors(data.next_player);
      if (data.winner) showResult(data.winner, data.winner === ' ' ? "Draw!" : `${data.winner} wins!`);
      break;

    case 'surrender':
      showResult(data.winner, `${data.winner} wins by surrender!`);
      break;

    case 'replay_vote':
      votes[data.from] = data.vote === 'yes';
      updateVotesUI();
      break;

    case 'error':
      alert(data.message);
      break;
  }
};

document.querySelectorAll(".small-square").forEach(sq => {
  sq.onclick = () => {
    if (!myPlayer || myPlayer !== document.getElementById("current-turn").textContent)
      return alert("Wait your turn");
    const mainIdx = parseInt(sq.dataset.main);
    if (currentActive !== null && mainIdx !== currentActive && subgameWinners[currentActive] === null) {
      return alert("You must play in the active subgrid!");
    }
    if (subgameWinners[mainIdx] !== null) {
      return alert("This subgrid has already been won!");
    }
    socket.send(JSON.stringify({
      action: 'move',
      player: myPlayer,
      main_index: mainIdx,
      sub_index: parseInt(sq.dataset.sub)
    }));
  };
});

document.getElementById("surrender-btn").onclick = () => {
  if (confirm("Are you sure you want to surrender?"))
    socket.send(JSON.stringify({ action: 'surrender', player: myPlayer }));
};

document.getElementById("vote-yes").onclick = () => sendVote(true);
document.getElementById("vote-no").onclick = () => sendVote(false);
document.getElementById("replay-btn").onclick = () => {
  resetGameUI();
  sendVote(true);
};
document.getElementById("exit-btn").onclick = () =>
  window.location.href = "{% url 'game:main_menu' %}";

function highlightActive(idx) {
  document.querySelectorAll(".big-board").forEach((board, i) => {
    if (i === idx && subgameWinners[i] === null) {
      board.style.boxShadow = idx !== null ? (document.getElementById("current-turn").textContent === 'X' ? '0 0 10px 4px red' : '0 0 10px 4px green') : "none";
    } else if (idx === null && subgameWinners[i] === null) {
      board.style.boxShadow = document.getElementById("current-turn").textContent === 'X' ? '0 0 10px 4px red' : '0 0 10px 4px green';
    } else {
      board.style.boxShadow = "none";
    }
  });
}

function showResult(winner, msg) {
  document.getElementById("resultTitle").textContent = winner === ' ' ? "Draw" : winner + " Wins!";
  document.getElementById("resultMessage").textContent = msg;
  document.getElementById("gameResultModal").style.display = 'block';
  animateResult(winner !== myPlayer);
  if (interval) clearInterval(interval);
  document.getElementById("vote-panel").style.display = 'block';
}

function animateResult(isLoss) {
  const container = document.querySelector('.confetti-container');
  container.innerHTML = '';
  if (isLoss) {
    for (let i = 0; i < 100; i++) {
      let drop = document.createElement('div');
      drop.className = 'rain-drop';
      drop.style.left = Math.random() * 100 + 'vw';
      drop.style.height = (5 + Math.random() * 10) + 'px';
      container.appendChild(drop);
    }
  } else {
    for (let i = 0; i < 150; i++) {
      let cf = document.createElement('div');
      cf.className = 'confetti';
      cf.style.left = Math.random() * 100 + 'vw';
      cf.style.width = (5 + Math.random() * 5) + 'px';
      container.appendChild(cf);
    }
    document.getElementById("confettiSound").play().catch(() => {});
  }
}

function sendVote(v) {
  socket.send(JSON.stringify({ action: 'replay_vote', from: myPlayer, vote: v ? 'yes' : 'no' }));
  if (!v) {
    setTimeout(() => window.location.href = "{% url 'game:main_menu' %}", 500);
  }
}

function updateVotesUI() {
  document.getElementById("vote-status").innerText =
    `Votes ‚Äî X: ${votes.X ? '‚úî' : '‚úò'} | O: ${votes.O ? '‚úî' : '‚úò'}`;
  if (votes.X && votes.O) {
    document.getElementById("vote-status").innerText += " ‚Äî Restarting game...";
  } else {
    document.getElementById("replay-btn").style.display = votes[myPlayer] ? 'inline-block' : 'none';
  }
}

function resetGameUI() {
  document.querySelectorAll(".small-square").forEach(sq => {
    sq.textContent = '';
    sq.style.pointerEvents = 'auto';
    sq.style.backgroundColor = '#f9f9f9';
    sq.style.color = '';
  });
  subgameWinners = Array(9).fill(null);
  currentActive = null;
  document.getElementById("gameResultModal").style.display = 'none';
  document.getElementById("vote-panel").style.display = 'none';
  votes = { X: false, O: false };
  document.querySelectorAll(".big-board").forEach(b => b.style.boxShadow = 'none');
}
</script>

{% endblock %}
